{% extends "base.html" %}
{% block title %}Call - {{ call.request.target_name }} - Obama Cares{% endblock %}
{% block content %}
<h1>Call: {{ call.request.target_name }}</h1>

<div class="grid">
    <article>
        <header>Call Information</header>
        <table>
            <tr><td><strong>Target</strong></td><td>{{ call.request.target_name }}</td></tr>
            <tr><td><strong>Company</strong></td><td>{{ call.request.company }}</td></tr>
            <tr><td><strong>Phone</strong></td><td>{{ call.request.phone_number }}</td></tr>
            <tr><td><strong>Scenario</strong></td><td>{{ call.request.scenario.value | replace('_', ' ') | title }}</td></tr>
            <tr><td><strong>Created</strong></td><td>{{ call.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td></tr>
        </table>

        <div id="call-status" hx-get="/api/calls/{{ call.id }}/status" hx-trigger="every 2s" hx-swap="outerHTML">
            <span class="status-badge status-{{ call.status.value }}">{{ call.status.value | replace('_', ' ') | title }}</span>
        </div>

        {% if call.notion_page_url %}
        <p><a href="{{ call.notion_page_url }}" target="_blank" role="button">View Notion Report</a></p>
        {% endif %}

        {% if call.status.value in ('in_progress', 'completed') %}
        <button hx-post="/api/calls/{{ call.id }}/complete" hx-target="#report-result" hx-swap="innerHTML">
            Generate Report
        </button>
        <div id="report-result"></div>
        {% endif %}
    </article>

    <div>
        {% if call.script %}
        <article>
            <header>Phishing Script</header>
            <p><strong>Persona:</strong> {{ call.script.persona_name }} - {{ call.script.persona_role }}</p>
            <p><strong>Introduction:</strong> {{ call.script.introduction }}</p>
            <h4>Key Talking Points</h4>
            <ul>
                {% for point in call.script.key_talking_points %}
                <li>{{ point }}</li>
                {% endfor %}
            </ul>
        </article>
        {% endif %}

        {% if call.research and call.research.synthesis %}
        <article>
            <header>Research Findings</header>
            <div>{{ call.research.synthesis }}</div>
        </article>
        {% endif %}
    </div>
</div>

<article>
    <header>Transcript</header>
    <div id="transcript" hx-get="/api/calls/{{ call.id }}/transcript"
         {% if call.status.value not in ('completed', 'failed') %}hx-trigger="every 3s"{% endif %}
         hx-swap="outerHTML">
        <div class="transcript-box">{{ call.transcript or 'Waiting for call to begin...' }}</div>
    </div>
</article>

{% if call.report_markdown %}
<article>
    <header>Assessment Report</header>
    <div class="transcript-box">{{ call.report_markdown }}</div>
</article>
{% endif %}
{% endblock %}
